<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Жизнь Шариков</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #326432;
            font-family: Arial, sans-serif;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #upload-container {
            margin: 20px;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
        }
        #upload-container h2 {
            text-align: center;
            margin-top: 0;
        }
        .upload-section {
            margin: 15px 0;
            padding: 10px;
            background-color: rgba(50, 50, 50, 0.7);
            border-radius: 5px;
        }
        .file-input {
            margin: 10px 0;
        }
        button {
            margin: 5px 0;
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        #start-btn {
            background-color: #2196F3;
            padding: 12px 25px;
            font-size: 18px;
            margin-top: 20px;
        }
        #start-btn:hover {
            background-color: #0b7dda;
        }
        canvas {
            display: block;
            border: 2px solid #333;
            margin: 10px auto;
        }
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            z-index: 100;
        }
        .resource {
            margin: 5px 0;
        }
        .profession-buttons {
            margin-top: 10px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="upload-container">
        <h2>Загрузка текстур для игры</h2>
        
        <div class="upload-section">
            <h3>Фоновое изображение (bg_game.png)</h3>
            <input type="file" id="bg-upload" class="file-input" accept="image/*">
        </div>
        
        <div class="upload-section">
            <h3>Изображение шарика (red_guy.png)</h3>
            <input type="file" id="ball-upload" class="file-input" accept="image/*">
        </div>
        
        <div class="upload-section">
            <h3>Изображение дома (basic_house.png)</h3>
            <input type="file" id="house-upload" class="file-input" accept="image/*">
        </div>
        
        <div class="upload-section">
            <h3>Изображение леса (forest.png)</h3>
            <input type="file" id="forest-upload" class="file-input" accept="image/*">
        </div>
        
        <div class="upload-section">
            <h3>Изображение фермы (not_ready_ground.png)</h3>
            <input type="file" id="farm-upload" class="file-input" accept="image/*">
        </div>
        
        <div class="upload-section">
            <h3>Иконка дерева (tree_icon.png)</h3>
            <input type="file" id="tree-icon-upload" class="file-input" accept="image/*">
        </div>
        
        <div class="upload-section">
            <h3>Иконка еды (food_icon.png)</h3>
            <input type="file" id="food-icon-upload" class="file-input" accept="image/*">
        </div>
        
        <button id="start-btn">Начать игру</button>
    </div>

    <canvas id="gameCanvas" class="hidden"></canvas>
    <div id="ui" class="hidden">
        <div id="timeInfo">День: 50%</div>
        <div class="resource" id="woodInfo">Дерево: 0</div>
        <div class="resource" id="foodInfo">Еда: 0</div>
        <div id="ballsInfo">Шариков: 3</div>
        <div id="selectedInfo" style="display: none;">Выбран: Безработный</div>
        <div class="profession-buttons" id="professionButtons" style="display: none;">
            <button onclick="setProfession(null)">Безработный</button>
            <button onclick="setProfession('lumberjack')">Дровосек</button>
            <button onclick="setProfession('farmer')">Фермер</button>
        </div>
    </div>

    <script>
        // Константы и настройки
        const WIDTH = 3840;
        const HEIGHT = 2160;
        const COLORS = {
            WHITE: '#FFFFFF',
            BLACK: '#000000',
            RED: '#FF0000',
            GREEN: '#00FF00',
            BLUE: '#0000FF',
            BROWN: '#8B4513',
            DARK_BROWN: '#654321',
            YELLOW: '#FFFF00',
            DARK_GREEN: '#006400'
        };

        // Элементы DOM
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const timeInfo = document.getElementById('timeInfo');
        const woodInfo = document.getElementById('woodInfo');
        const foodInfo = document.getElementById('foodInfo');
        const ballsInfo = document.getElementById('ballsInfo');
        const selectedInfo = document.getElementById('selectedInfo');
        const professionButtons = document.getElementById('professionButtons');
        const uploadContainer = document.getElementById('upload-container');
        const startBtn = document.getElementById('start-btn');

        // Настройка canvas
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let scaleX = canvas.width / WIDTH;
        let scaleY = canvas.height / HEIGHT;

        // Глобальные переменные игры
        let balls = [];
        let woodStorage = 0;
        let foodStorage = 0;
        let gameTime = 360;
        let selectedBall = null;
        let lastTime = 0;
        let imagesLoaded = 0;
        let totalImages = 7;

        // Время дня
        const DAY_NIGHT_CYCLE = 900;
        const DAY_DURATION = 720;
        const NIGHT_DURATION = 180;

        // Объекты для хранения изображений
        const images = {
            background: null,
            ball: null,
            house: null,
            forest: null,
            farm: null,
            treeIcon: null,
            foodIcon: null
        };

        // Позиции объектов
        const housePos = { x: 100, y: HEIGHT / 2 - 100 };
        const forestPos = { x: WIDTH - 450, y: 100 };
        const farmPos = { x: WIDTH - 450, y: HEIGHT - 500 };
        const storagePos = { x: housePos.x + 100, y: housePos.y + 100 };

        // Функции для создания изображений по умолчанию
        function createCircleImage(size, color) {
            const offscreen = document.createElement('canvas');
            offscreen.width = size;
            offscreen.height = size;
            const octx = offscreen.getContext('2d');
            
            octx.beginPath();
            octx.arc(size/2, size/2, size/2, 0, Math.PI * 2);
            octx.fillStyle = color;
            octx.fill();
            
            return offscreen;
        }

        function createHouseImage(width, height) {
            const offscreen = document.createElement('canvas');
            offscreen.width = width;
            offscreen.height = height;
            const octx = offscreen.getContext('2d');
            
            // Дом
            octx.fillStyle = COLORS.BROWN;
            octx.fillRect(50, 100, 100, 100);
            
            // Крыша
            octx.beginPath();
            octx.moveTo(30, 100);
            octx.lineTo(170, 100);
            octx.lineTo(100, 30);
            octx.closePath();
            octx.fillStyle = COLORS.RED;
            octx.fill();
            
            // Окно
            octx.fillStyle = COLORS.YELLOW;
            octx.fillRect(80, 120, 40, 40);
            
            return offscreen;
        }

        function createTreeImage(width, height) {
            const offscreen = document.createElement('canvas');
            offscreen.width = width;
            offscreen.height = height;
            const octx = offscreen.getContext('2d');
            
            // Ствол
            octx.fillStyle = COLORS.DARK_BROWN;
            octx.fillRect(width/2-5, height/2, 10, height/2);
            
            // Крона
            octx.beginPath();
            octx.arc(width/2, height/3, height/3, 0, Math.PI * 2);
            octx.fillStyle = COLORS.GREEN;
            octx.fill();
            
            return offscreen;
        }

        function createFarmImage(width, height) {
            const offscreen = document.createElement('canvas');
            offscreen.width = width;
            offscreen.height = height;
            const octx = offscreen.getContext('2d');
            
            octx.fillStyle = COLORS.DARK_BROWN;
            octx.fillRect(0, 0, width, height);
            
            // Добавляем детали фермы
            octx.fillStyle = COLORS.YELLOW;
            for (let i = 0; i < 5; i++) {
                for (let j = 0; j < 5; j++) {
                    if ((i + j) % 2 === 0) {
                        octx.fillRect(i * width/5, j * height/5, width/5, height/5);
                    }
                }
            }
            
            return offscreen;
        }

        function createBackground() {
            const offscreen = document.createElement('canvas');
            offscreen.width = WIDTH;
            offscreen.height = HEIGHT;
            const octx = offscreen.getContext('2d');
            
            // Зеленый фон для травы
            octx.fillStyle = '#326432';
            octx.fillRect(0, 0, WIDTH, HEIGHT);
            
            // Добавляем детали травы
            octx.fillStyle = '#4682B4';
            for (let i = 0; i < 1000; i++) {
                const x = Math.random() * WIDTH;
                const y = Math.random() * HEIGHT;
                const size = Math.random() * 5 + 1;
                octx.beginPath();
                octx.arc(x, y, size, 0, Math.PI * 2);
                octx.fill();
            }
            
            return offscreen;
        }

        // Функция загрузки изображения
        function loadImage(fileInput, imageKey, defaultCreator, ...args) {
            return new Promise((resolve) => {
                if (fileInput.files && fileInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            images[imageKey] = img;
                            imagesLoaded++;
                            resolve();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(fileInput.files[0]);
                } else {
                    // Используем изображение по умолчанию
                    images[imageKey] = defaultCreator(...args);
                    imagesLoaded++;
                    resolve();
                }
            });
        }

        // Класс для шариков
        class Ball {
            constructor(x, y) {
                this.size = 40;
                this.x = x;
                this.y = y;
                this.speedX = Math.random() * 1 - 0.5;
                this.speedY = Math.random() * 1 - 0.5;
                this.jumpHeight = Math.random() * 1 + 1;
                this.jumpSpeed = Math.random() * 0.1 + 0.1;
                this.jumpPhase = Math.random() * Math.PI * 2;
                this.groundY = this.y;
                this.isPaused = false;
                this.pauseTimer = 0;
                this.pauseDuration = 0.5;
                this.originalJumpSpeed = this.jumpSpeed;
                
                this.profession = null;
                this.carrying = 0;
                this.resourceType = null;
                this.target = null;
                this.state = "idle";
                this.sleeping = false;
                this.workTimer = 0;
                this.wakingUp = false;
                this.nightCall = false;
            }
            
            update(dt, isNight, dayProgress) {
                if (isNight && !this.sleeping && !this.wakingUp && this.state !== "going_home") {
                    this.nightCall = true;
                    this.state = "going_home";
                    this.target = storagePos;
                }
                
                if (isNight && this.state === "going_home") {
                    this.moveTowards(this.target, 1.5);
                    
                    if (this.distanceTo(this.target) < 10) {
                        this.state = "sleeping";
                        this.sleeping = true;
                        this.speedX = 0;
                        this.speedY = 0;
                        this.nightCall = false;
                    }
                    return;
                }
                
                if (this.sleeping && dayProgress >= 0.05 && !this.wakingUp) {
                    this.wakingUp = true;
                    this.sleeping = false;
                    if (this.carrying > 0) {
                        this.state = "going_to_storage";
                        this.target = storagePos;
                    } else {
                        this.state = "idle";
                    }
                }
                
                if (this.wakingUp && !this.sleeping) {
                    this.wakingUp = false;
                }
                
                if (this.isPaused) {
                    this.pauseTimer += dt;
                    if (this.pauseTimer >= this.pauseDuration) {
                        this.isPaused = false;
                        this.pauseTimer = 0;
                        this.jumpSpeed = this.originalJumpSpeed;
                    }
                    return;
                }
                
                if (isNight) {
                    return;
                }
                
                if (this.profession === null) {
                    this.idleBehavior(dt);
                } else {
                    this.workingBehavior(dt);
                }
            }
            
            idleBehavior(dt) {
                if (Math.random() < 0.01) {
                    this.speedX = Math.random() * 1 - 0.5;
                    this.speedY = Math.random() * 1 - 0.5;
                }
                
                this.x += this.speedX;
                this.y += this.speedY;
                
                this.jumpPhase += this.jumpSpeed;
                const verticalOffset = Math.sin(this.jumpPhase) * this.jumpHeight;
                this.y = this.groundY + verticalOffset;
                
                if (Math.abs(Math.sin(this.jumpPhase) - 1.0) < 0.05) {
                    this.isPaused = true;
                    this.jumpSpeed = 0;
                }
                
                if (this.x <= 0 || this.x >= WIDTH - this.size) {
                    this.speedX *= -1;
                    this.x = Math.max(0, Math.min(this.x, WIDTH - this.size));
                }
                
                if (this.y <= 0 || this.y >= HEIGHT - this.size) {
                    this.speedY *= -1;
                    this.y = Math.max(0, Math.min(this.y, HEIGHT - this.size));
                    this.groundY = this.y;
                }
            }
            
            workingBehavior(dt) {
                if (this.state === "idle") {
                    if (this.profession === "lumberjack") {
                        this.target = {
                            x: forestPos.x + Math.random() * 300 + 50,
                            y: forestPos.y + Math.random() * 300 + 50
                        };
                        this.state = "going_to_work";
                    } else if (this.profession === "farmer") {
                        this.target = {
                            x: farmPos.x + Math.random() * 300 + 50,
                            y: farmPos.y + Math.random() * 300 + 50
                        };
                        this.state = "going_to_work";
                    }
                } else if (this.state === "going_to_work") {
                    this.moveTowards(this.target, 1.0);
                    
                    if (this.distanceTo(this.target) < 10) {
                        this.state = "working";
                        this.workTimer = 0;
                    }
                } else if (this.state === "working") {
                    this.workTimer += dt;
                    if (this.workTimer >= 2.0) {
                        this.workTimer = 0;
                        this.carrying += 10;
                        
                        if (this.profession === "lumberjack") {
                            this.resourceType = "wood";
                        } else {
                            this.resourceType = "food";
                        }
                        
                        if (this.carrying >= 100) {
                            this.state = "going_to_storage";
                            this.target = storagePos;
                        }
                    }
                } else if (this.state === "going_to_storage") {
                    this.moveTowards(this.target, 1.0);
                    
                    if (this.distanceTo(this.target) < 10) {
                        if (this.resourceType === "wood") {
                            woodStorage += this.carrying;
                        } else {
                            foodStorage += this.carrying;
                        }
                        
                        this.carrying = 0;
                        this.resourceType = null;
                        this.state = "idle";
                    }
                }
            }
            
            moveTowards(target, speed) {
                const dx = target.x - this.x;
                const dy = target.y - this.y;
                const distance = Math.max(0.1, Math.sqrt(dx * dx + dy * dy));
                
                this.speedX = (dx / distance) * speed;
                this.speedY = (dy / distance) * speed;
                
                this.x += this.speedX;
                this.y += this.speedY;
                
                this.jumpPhase += this.jumpSpeed;
                const verticalOffset = Math.sin(this.jumpPhase) * this.jumpHeight;
                this.groundY = this.y;
                this.y = this.groundY + verticalOffset;
                
                if (Math.abs(Math.sin(this.jumpPhase) - 1.0) < 0.05) {
                    this.isPaused = true;
                    this.jumpSpeed = 0;
                }
            }
            
            distanceTo(target) {
                const dx = target.x - this.x;
                const dy = target.y - this.y;
                return Math.sqrt(dx * dx + dy * dy);
            }
            
            draw(ctx) {
                if (images.ball && typeof images.ball !== 'string') {
                    ctx.drawImage(images.ball, this.x * scaleX, this.y * scaleY, this.size * scaleX, this.size * scaleY);
                } else {
                    ctx.fillStyle = COLORS.RED;
                    ctx.beginPath();
                    ctx.arc((this.x + this.size/2) * scaleX, (this.y + this.size/2) * scaleY, this.size/2 * scaleX, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                if (this.carrying > 0) {
                    ctx.fillStyle = COLORS.WHITE;
                    ctx.font = `${20 * scaleX}px Arial`;
                    ctx.fillText(
                        this.carrying.toString(), 
                        (this.x + this.size/2 - 10) * scaleX, 
                        (this.y - 20) * scaleY
                    );
                    
                    const icon = this.resourceType === "wood" ? images.treeIcon : images.foodIcon;
                    if (icon) {
                        const iconSize = 30;
                        ctx.drawImage(
                            icon, 
                            (this.x + this.size/2 - 15) * scaleX, 
                            (this.y - 50) * scaleY, 
                            iconSize * scaleX, 
                            iconSize * scaleY
                        );
                    }
                }
                
                if (this.sleeping) {
                    ctx.fillStyle = COLORS.WHITE;
                    ctx.font = `${20 * scaleX}px Arial`;
                    ctx.fillText(
                        "Zzz", 
                        (this.x + this.size/2 - 10) * scaleX, 
                        (this.y - 20) * scaleY
                    );
                }
                
                if (!this.sleeping) {
                    let statusText = "";
                    if (this.profession === null) {
                        statusText = "Безработный";
                    } else if (this.state === "going_to_work") {
                        statusText = "Идет на работу";
                    } else if (this.state === "working") {
                        statusText = "Работает";
                    } else if (this.state === "going_to_storage") {
                        statusText = "Несет ресурсы";
                    } else if (this.state === "going_home") {
                        statusText = "Идет домой";
                    }
                    
                    if (statusText) {
                        ctx.fillStyle = COLORS.WHITE;
                        ctx.font = `${16 * scaleX}px Arial`;
                        ctx.fillText(
                            statusText, 
                            (this.x + this.size/2 - 40) * scaleX, 
                            (this.y - 70) * scaleY
                        );
                    }
                }
            }
            
            isPointInside(x, y) {
                const scaledX = x / scaleX;
                const scaledY = y / scaleY;
                return (
                    scaledX >= this.x && 
                    scaledX <= this.x + this.size && 
                    scaledY >= this.y && 
                    scaledY <= this.y + this.size
                );
            }
        }

        // Инициализация игры
        async function initGame() {
            // Загрузка изображений
            await loadImage(
                document.getElementById('bg-upload'), 
                'background', 
                createBackground
            );
            
            await loadImage(
                document.getElementById('ball-upload'), 
                'ball', 
                createCircleImage, 40, COLORS.RED
            );
            
            await loadImage(
                document.getElementById('house-upload'), 
                'house', 
                createHouseImage, 200, 200
            );
            
            await loadImage(
                document.getElementById('forest-upload'), 
                'forest', 
                createTreeImage, 400, 400
            );
            
            await loadImage(
                document.getElementById('farm-upload'), 
                'farm', 
                createFarmImage, 400, 400
            );
            
            await loadImage(
                document.getElementById('tree-icon-upload'), 
                'treeIcon', 
                createCircleImage, 30, COLORS.GREEN
            );
            
            await loadImage(
                document.getElementById('food-icon-upload'), 
                'foodIcon', 
                createCircleImage, 30, COLORS.YELLOW
            );
            
            // Создание шариков
            for (let i = 0; i < 3; i++) {
                balls.push(new Ball(housePos.x + 100, housePos.y + 100));
            }
            
            // Показываем игровые элементы
            canvas.classList.remove('hidden');
            ui.classList.remove('hidden');
            uploadContainer.classList.add('hidden');
            
            // Запуск игрового цикла
            requestAnimationFrame(gameLoop);
            
            // Обработка событий
            canvas.addEventListener('click', handleClick);
            window.addEventListener('keydown', handleKeyDown);
            window.addEventListener('resize', handleResize);
        }

        // Игровой цикл
        function gameLoop(timestamp) {
            const dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;
            
            gameTime += dt;
            
            const cyclePosition = gameTime % DAY_NIGHT_CYCLE;
            const isNight = cyclePosition > DAY_DURATION;
            
            let dayProgress = 0.0;
            if (!isNight) {
                dayProgress = cyclePosition / DAY_DURATION;
            }
            
            let darkness = 0;
            if (isNight) {
                const nightProgress = (cyclePosition - DAY_DURATION) / NIGHT_DURATION;
                darkness = Math.min(200, Math.floor(nightProgress * 200));
            } else {
                if (dayProgress < 0.05) {
                    darkness = Math.floor((1 - dayProgress / 0.05) * 200);
                }
            }
            
            updateUI(isNight, cyclePosition, dayProgress);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Отрисовка фона
            if (images.background) {
                ctx.drawImage(images.background, 0, 0, canvas.width, canvas.height);
            }
            
            // Отрисовка объектов
            if (images.house) {
                ctx.drawImage(
                    images.house, 
                    housePos.x * scaleX, 
                    housePos.y * scaleY, 
                    200 * scaleX, 
                    200 * scaleY
                );
            }
            
            if (images.forest) {
                ctx.drawImage(
                    images.forest, 
                    forestPos.x * scaleX, 
                    forestPos.y * scaleY, 
                    400 * scaleX, 
                    400 * scaleY
                );
            }
            
            if (images.farm) {
                ctx.drawImage(
                    images.farm, 
                    farmPos.x * scaleX, 
                    farmPos.y * scaleY, 
                    400 * scaleX, 
                    400 * scaleY
                );
            }
            
            // Обновление и отрисовка шариков
            for (const ball of balls) {
                ball.update(dt, isNight, dayProgress);
                ball.draw(ctx);
            }
            
            // Затемнение экрана ночью
            if (darkness > 0) {
                ctx.fillStyle = `rgba(0, 0, 0, ${darkness / 255})`;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            requestAnimationFrame(gameLoop);
        }

        // Обновление UI
        function updateUI(isNight, cyclePosition, dayProgress) {
            const timeText = isNight ? "Ночь" : "День";
            const timeProgressText = isNight 
                ? `${Math.floor((cyclePosition - DAY_DURATION) / NIGHT_DURATION * 100)}%`
                : `${Math.floor(dayProgress * 100)}%`;
                
            timeInfo.textContent = `${timeText}: ${timeProgressText}`;
            woodInfo.textContent = `Дерево: ${woodStorage}`;
            foodInfo.textContent = `Еда: ${foodStorage}`;
            ballsInfo.textContent = `Шариков: ${balls.length}`;
            
            if (selectedBall) {
                selectedInfo.style.display = 'block';
                professionButtons.style.display = 'block';
                selectedInfo.textContent = `Выбран: ${selectedBall.profession || 'Безработный'}`;
            } else {
                selectedInfo.style.display = 'none';
                professionButtons.style.display = 'none';
            }
        }

        // Обработчики событий
        function handleClick(event) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            for (const ball of balls) {
                if (ball.isPointInside(x, y)) {
                    selectedBall = ball;
                    return;
                }
            }
            
            selectedBall = null;
        }

        function handleKeyDown(event) {
            if (event.key === 'Escape') {
                // Возврат к меню загрузки
                canvas.classList.add('hidden');
                ui.classList.add('hidden');
                uploadContainer.classList.remove('hidden');
            } else if (event.key === ' ' || event.key === 'Space') {
                balls.push(new Ball(housePos.x + 100, housePos.y + 100));
            }
        }

        function handleResize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            scaleX = canvas.width / WIDTH;
            scaleY = canvas.height / HEIGHT;
        }

        function setProfession(profession) {
            if (selectedBall) {
                selectedBall.profession = profession;
            }
        }

        // Запуск игры при нажатии кнопки
        startBtn.addEventListener('click', initGame);
    </script>
</body>
</html>
