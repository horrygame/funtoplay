<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Шариковое поселение</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background-color: #2c3e50;
            color: #ecf0f1;
        }
        canvas {
            display: block;
        }
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(44, 62, 80, 0.8);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            width: 250px;
        }
        .resources {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .resource {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        button {
            padding: 8px 15px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #3498db;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }
        .selected-ball-info {
            margin-top: 15px;
            padding: 10px;
            background: rgba(52, 152, 219, 0.2);
            border-radius: 5px;
            display: none;
        }
        .upgrade-btn {
            background: #27ae60;
        }
        .upgrade-btn:hover {
            background: #219653;
        }
        .work-btn {
            background: #e67e22;
        }
        .work-btn:hover {
            background: #d35400;
        }
        .building {
            position: absolute;
            cursor: pointer;
        }
        .building-info {
            position: absolute;
            background: rgba(44, 62, 80, 0.9);
            padding: 10px;
            border-radius: 5px;
            display: none;
            max-width: 200px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div class="controls">
        <h2>Поселение шариков</h2>
        <div class="resources">
            <div class="resource">Дерево: <span id="woodCount">100</span></div>
            <div class="resource">Еда: <span id="foodCount">50</span></div>
            <div class="resource">Шариков: <span id="ballCount">5</span></div>
        </div>
        <button id="addBall" disabled>Новый поселенец (50 еды)</button>
        <div class="selected-ball-info" id="selectedBallInfo">
            <h3>Выбранный шарик</h3>
            <div>Уровень: <span id="ballLevel">1</span></div>
            <div>Грузоподъемность: <span id="ballCapacity">100</span></div>
            <div>Скорость: <span id="ballSpeed">1</span></div>
            <div>Потребление: <span id="ballConsumption">1</span> ед/мин</div>
            <button class="upgrade-btn" id="upgradeBall">Улучшить (25 еды)</button>
            <button class="work-btn" id="assignWood">Рубить дерево</button>
            <button class="work-btn" id="assignFarm">Работать на ферме</button>
            <button id="moveBall">Переместить</button>
        </div>
    </div>

    <script>
        // Получаем элементы DOM
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const woodCountElement = document.getElementById('woodCount');
        const foodCountElement = document.getElementById('foodCount');
        const ballCountElement = document.getElementById('ballCount');
        const addBallButton = document.getElementById('addBall');
        const selectedBallInfo = document.getElementById('selectedBallInfo');
        const ballLevelElement = document.getElementById('ballLevel');
        const ballCapacityElement = document.getElementById('ballCapacity');
        const ballSpeedElement = document.getElementById('ballSpeed');
        const ballConsumptionElement = document.getElementById('ballConsumption');
        const upgradeBallButton = document.getElementById('upgradeBall');
        const assignWoodButton = document.getElementById('assignWood');
        const assignFarmButton = document.getElementById('assignFarm');
        const moveBallButton = document.getElementById('moveBall');
        
        // Устанавливаем размер canvas
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        // Ресурсы и состояние игры
        let resources = {
            wood: 100,
            food: 50
        };
        
        let buildings = {
            house: { x: 50, y: 50, width: 100, height: 100 },
            farm: { x: canvas.width - 200, y: canvas.height/2 - 100, width: 200, height: 200, ready: false, progress: 0 },
            forest: { x: canvas.width - 250, y: 50, width: 200, height: 200, trees: 10 }
        };
        
        let balls = [];
        let selectedBall = null;
        let isPaused = false;
        let houseImg, ballImg, bgImg, farmReadyImg, farmNotReadyImg, forestImg;
        let imagesLoaded = 0;
        const totalImages = 6;
        let lastTime = 0;
        
        // Загрузка изображений
        function loadImages() {
            houseImg = new Image();
            houseImg.src = 'basic_house.png';
            houseImg.onload = imageLoaded;
            
            ballImg = new Image();
            ballImg.src = 'reb_guy.png';
            ballImg.onload = imageLoaded;
            
            bgImg = new Image();
            bgImg.src = 'bg_game.png';
            bgImg.onload = imageLoaded;
            
            farmReadyImg = new Image();
            farmReadyImg.src = 'ready_ground.png';
            farmReadyImg.onload = imageLoaded;
            
            farmNotReadyImg = new Image();
            farmNotReadyImg.src = 'not_ready_ground.png';
            farmNotReadyImg.onload = imageLoaded;
            
            forestImg = new Image();
            forestImg.src = 'forest.png';
            forestImg.onload = imageLoaded;
        }
        
        function imageLoaded() {
            imagesLoaded++;
            if (imagesLoaded === totalImages) {
                initGame();
                requestAnimationFrame(gameLoop);
            }
        }
        
        // Класс для шариков
        class Ball {
            constructor() {
                this.radius = 25;
                this.x = buildings.house.x + buildings.house.width/2;
                this.y = buildings.house.y + buildings.house.height/2;
                this.speedX = 0;
                this.speedY = 0;
                this.targetX = null;
                this.targetY = null;
                this.jumpPhase = Math.random() * Math.PI * 2;
                this.jumpHeight = 3;
                this.jumpSpeed = 0.08;
                this.baseY = this.y;
                this.level = 1;
                this.capacity = 100;
                this.speedMultiplier = 1;
                this.foodConsumption = 1;
                this.resource = null;
                this.resourceAmount = 0;
                this.workTarget = null;
                this.workType = null;
                this.isWorking = false;
                this.workProgress = 0;
                this.id = Math.random().toString(36).substring(7);
            }
            
            update(deltaTime) {
                // Движение к цели
                if (this.targetX !== null && this.targetY !== null) {
                    const dx = this.targetX - this.x;
                    const dy = this.targetY - this.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance > 5) {
                        this.speedX = (dx / distance) * 2 * this.speedMultiplier;
                        this.speedY = (dy / distance) * 2 * this.speedMultiplier;
                    } else {
                        this.speedX = 0;
                        this.speedY = 0;
                        this.targetX = null;
                        this.targetY = null;
                        
                        // Если достигли рабочего места, начинаем работу
                        if (this.workTarget) {
                            this.isWorking = true;
                        }
                    }
                }
                
                // Обновление позиции
                this.x += this.speedX;
                this.baseY += this.speedY;
                
                // Анимация прыжка
                this.jumpPhase += this.jumpSpeed;
                this.y = this.baseY + Math.sin(this.jumpPhase) * this.jumpHeight;
                
                // Работа на ферме
                if (this.isWorking && this.workType === 'farm') {
                    this.workProgress += deltaTime / 1000;
                    
                    if (this.workProgress >= 5) { // 5 секунд на сбор урожая
                        this.workProgress = 0;
                        this.resource = 'food';
                        this.resourceAmount = this.capacity;
                        buildings.farm.ready = false;
                        buildings.farm.progress = 0;
                        this.isWorking = false;
                        this.workTarget = 'house'; // Возвращаемся домой
                        this.setTarget(buildings.house.x + buildings.house.width/2, buildings.house.y + buildings.house.height/2);
                    }
                }
                
                // Работа в лесу
                if (this.isWorking && this.workType === 'wood') {
                    this.workProgress += deltaTime / 1000;
                    
                    if (this.workProgress >= 3) { // 3 секунды на рубку дерева
                        this.workProgress = 0;
                        this.resource = 'wood';
                        this.resourceAmount = Math.min(this.capacity, 20); // Макс 20 дерева за раз
                        buildings.forest.trees = Math.max(0, buildings.forest.trees - 1);
                        this.isWorking = false;
                        this.workTarget = 'house'; // Возвращаемся домой
                        this.setTarget(buildings.house.x + buildings.house.width/2, buildings.house.y + buildings.house.height/2);
                    }
                }
                
                // Если вернулись домой с ресурсами
                if (this.workTarget === 'house' && this.resourceAmount > 0 && 
                    this.distanceTo(buildings.house.x + buildings.house.width/2, buildings.house.y + buildings.house.height/2) < 30) {
                    resources[this.resource] += this.resourceAmount;
                    this.resourceAmount = 0;
                    this.resource = null;
                    updateResources();
                    
                    // Возвращаемся к работе, если она была назначена
                    if (this.workType) {
                        if (this.workType === 'farm') {
                            this.workTarget = 'farm';
                            this.setTarget(buildings.farm.x + buildings.farm.width/2, buildings.farm.y + buildings.farm.height/2);
                        } else if (this.workType === 'wood') {
                            this.workTarget = 'forest';
                            this.setTarget(buildings.forest.x + buildings.forest.width/2, buildings.forest.y + buildings.forest.height/2);
                        }
                    }
                }
            }
            
            setTarget(x, y) {
                this.targetX = x;
                this.targetY = y;
                this.isWorking = false;
            }
            
            distanceTo(x, y) {
                const dx = this.x - x;
                const dy = this.y - y;
                return Math.sqrt(dx * dx + dy * dy);
            }
            
            draw() {
                let scale = 1.0 + 0.1 * Math.sin(this.jumpPhase);
                let offsetY = 0;
                
                const size = this.radius * 2 * scale;
                ctx.drawImage(
                    ballImg, 
                    this.x - size/2, 
                    this.y - size/2 + offsetY, 
                    size, 
                    size
                );
                
                // Отображение уровня шарика
                ctx.fillStyle = '#ffffff';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(this.level.toString(), this.x, this.y + 5);
                
                // Отображение ресурсов, если есть
                if (this.resourceAmount > 0) {
                    ctx.fillStyle = this.resource === 'wood' ? '#8B4513' : '#FFD700';
                    ctx.fillRect(this.x - 20, this.y - 40, 40 * (this.resourceAmount / this.capacity), 5);
                }
            }
            
            upgrade() {
                this.level++;
                this.capacity += 20;
                this.speedMultiplier += 0.2;
                this.foodConsumption += 0.5;
                resources.food -= 25;
                updateResources();
                updateSelectedBallInfo();
            }
            
            assignWork(type) {
                this.workType = type;
                
                if (type === 'wood') {
                    this.workTarget = 'forest';
                    this.setTarget(buildings.forest.x + buildings.forest.width/2, buildings.forest.y + buildings.forest.height/2);
                } else if (type === 'farm') {
                    this.workTarget = 'farm';
                    this.setTarget(buildings.farm.x + buildings.farm.width/2, buildings.farm.y + buildings.farm.height/2);
                }
            }
        }
        
        // Инициализация игры
        function initGame() {
            // Создаем начальные шарики
            for (let i = 0; i < 5; i++) {
                balls.push(new Ball());
            }
            
            // Обработчик клика по canvas
            canvas.addEventListener('click', (e) => {
                if (isPaused) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Проверяем, не кликнули ли по UI
                if (x < 300 && y < 400) return;
                
                // Проверяем, кликнули ли по шарику
                let clickedOnBall = false;
                for (let i = balls.length - 1; i >= 0; i--) {
                    const ball = balls[i];
                    const dx = ball.x - x;
                    const dy = ball.y - y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < ball.radius) {
                        selectBall(ball);
                        clickedOnBall = true;
                        break;
                    }
                }
                
                // Если кликнули не по шарику, но есть выбранный шарик - перемещаем его
                if (!clickedOnBall && selectedBall) {
                    selectedBall.setTarget(x, y);
                    selectedBall.workType = null;
                    selectedBall.workTarget = null;
                    selectedBall.isWorking = false;
                }
            });
            
            // Кнопка добавления шарика
            addBallButton.addEventListener('click', () => {
                if (resources.food >= 50) {
                    const newBall = new Ball();
                    balls.push(newBall);
                    resources.food -= 50;
                    updateResources();
                    updateBallCount();
                }
            });
            
            // Кнопка улучшения шарика
            upgradeBallButton.addEventListener('click', () => {
                if (selectedBall && resources.food >= 25) {
                    selectedBall.upgrade();
                }
            });
            
            // Кнопки назначения работы
            assignWoodButton.addEventListener('click', () => {
                if (selectedBall) {
                    selectedBall.assignWork('wood');
                }
            });
            
            assignFarmButton.addEventListener('click', () => {
                if (selectedBall) {
                    selectedBall.assignWork('farm');
                }
            });
            
            // Кнопка перемещения
            moveBallButton.addEventListener('click', () => {
                if (selectedBall) {
                    selectedBall.workType = null;
                    selectedBall.workTarget = null;
                    selectedBall.isWorking = false;
                }
            });
            
            // Обработчик изменения размера окна
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                // Обновляем позиции зданий
                buildings.farm.x = canvas.width - 200;
                buildings.forest.x = canvas.width - 250;
            });
            
            updateResources();
            updateBallCount();
        }
        
        // Обновление счетчиков ресурсов
        function updateResources() {
            woodCountElement.textContent = resources.wood;
            foodCountElement.textContent = resources.food;
            
            // Активируем кнопку добавления шарика, если достаточно еды
            addBallButton.disabled = resources.food < 50;
        }
        
        // Обновление счетчика шариков
        function updateBallCount() {
            ballCountElement.textContent = balls.length;
        }
        
        // Выбор шарика
        function selectBall(ball) {
            selectedBall = ball;
            selectedBallInfo.style.display = 'block';
            updateSelectedBallInfo();
        }
        
        // Обновление информации о выбранном шарике
        function updateSelectedBallInfo() {
            if (!selectedBall) return;
            
            ballLevelElement.textContent = selectedBall.level;
            ballCapacityElement.textContent = selectedBall.capacity;
            ballSpeedElement.textContent = selectedBall.speedMultiplier.toFixed(1);
            ballConsumptionElement.textContent = selectedBall.foodConsumption.toFixed(1);
            
            // Активируем кнопку улучшения, если достаточно еды
            upgradeBallButton.disabled = resources.food < 25;
        }
        
        // Обновление состояния фермы
        function updateFarm(deltaTime) {
            if (!buildings.farm.ready) {
                buildings.farm.progress += deltaTime / 1000 / 60; // 1 минута для созревания
                
                if (buildings.farm.progress >= 1) {
                    buildings.farm.ready = true;
                }
            }
        }
        
        // Потребление еды шариками
        function consumeFood(deltaTime) {
            const totalConsumption = balls.reduce((sum, ball) => sum + ball.foodConsumption, 0) * (deltaTime / 1000 / 60);
            resources.food = Math.max(0, resources.food - totalConsumption);
            updateResources();
        }
        
        // Основной игровой цикл
        function gameLoop(timestamp) {
            if (!lastTime) lastTime = timestamp;
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;
            
            if (isPaused) return;
            
            // Очищаем canvas
            ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
            
            // Рисуем здания
            ctx.drawImage(houseImg, buildings.house.x, buildings.house.y, buildings.house.width, buildings.house.height);
            
            // Рисуем ферму
            const farmImg = buildings.farm.ready ? farmReadyImg : farmNotReadyImg;
            ctx.drawImage(farmImg, buildings.farm.x, buildings.farm.y, buildings.farm.width, buildings.farm.height);
            
            // Рисуем лес
            ctx.drawImage(forestImg, buildings.forest.x, buildings.forest.y, buildings.forest.width, buildings.forest.height);
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.font = '16px Arial';
            ctx.fillText(`Деревьев: ${buildings.forest.trees}`, buildings.forest.x + 10, buildings.forest.y + 20);
            
            // Обновляем и рисуем шарики
            balls.forEach(ball => {
                ball.update(deltaTime);
                ball.draw();
            });
            
            // Обновляем состояние фермы
            updateFarm(deltaTime);
            
            // Потребление еды
            consumeFood(deltaTime);
            
            // Удаляем шарики, если еды недостаточно (голод)
            if (resources.food <= 0) {
                if (balls.length > 0) {
                    balls.pop();
                    updateBallCount();
                    resources.food = 0;
                    updateResources();
                }
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        // Запускаем загрузку изображений
        loadImages();
    </script>
</body>
</html>
